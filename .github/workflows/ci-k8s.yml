name: CI with Minikube Kubernetes Deployment

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Set up Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 3ï¸âƒ£ Install dependencies and train model
    - name: Install dependencies and train model
      run: |
        pip install -U pip
        pip install fastapi uvicorn scikit-learn pandas joblib numpy
        python train.py

    # 4ï¸âƒ£ Set up Minikube
    - name: Start Minikube
      uses: medyagh/setup-minikube@latest
      with:
        kubernetes-version: "v1.30.0"

    # 5ï¸âƒ£ Build Docker image inside Minikube
    - name: Build Docker image in Minikube
      run: |
        eval $(minikube -p minikube docker-env)
        docker build -t diabetes-api:latest .

    # 6ï¸âƒ£ Deploy FastAPI app to Minikube
    - name: Deploy to Minikube
      run: |
        kubectl apply -f k8s-deploy.yml
        echo "âœ… Deployment applied successfully!"
        echo "Waiting for pods to be ready..."
        kubectl wait --for=condition=ready pod -l app=diabetes-api --timeout=90s
        kubectl get pods
        kubectl get svc

    # 7ï¸âƒ£ Test FastAPI endpoint inside cluster (with debug)
    - name: Test service using port-forward
      run: |
        echo "ğŸ•µï¸ Checking pod status before test..."
        kubectl get pods -o wide
        echo "ğŸ” Describe pod for debug..."
        kubectl describe pod -l app=diabetes-api
        echo "ğŸ“œ Container logs:"
        kubectl logs -l app=diabetes-api || true
        echo "ğŸš€ Port-forwarding service..."
        kubectl port-forward service/diabetes-service 8000:8000 &
        sleep 10
        curl http://127.0.0.1:8000/ || true

